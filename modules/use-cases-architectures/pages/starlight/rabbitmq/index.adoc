= Getting started with the {starlight-rabbitmq} extension
:navtitle: {starlight-rabbitmq}
:description: Learn how to get started using the {starlight-rabbitmq} extension with {pulsar-short} and get hands on by publishing and consuming messages from a topic.

{starlight-rabbitmq} acts as a proxy between your https://www.rabbitmq.com/[RabbitMQ] application and https://pulsar.apache.org/[{pulsar-reg}] cluster.
It implements the AMQP 0.9.1 protocol used by RabbitMQ clients and translates AMQP frames and concepts to {pulsar-short} concepts.

If source code is your thing, visit the https://github.com/datastax/starlight-for-rabbitmq[project's repo on GitHub].

== Architecture reference

If you want to dive deep into how {starlight-rabbitmq} works, xref:starlight-for-rabbitmq:ROOT:index.adoc[read the documentation].

image:s4r-architecture.png[{starlight-rabbitmq} Architecture]

== Establishing the RabbitMQ protocol handler

Before you can use a RabbitMQ client to interact with your {pulsar-short} cluster, you need the {starlight-rabbitmq} protocol handler installed in the cluster.
Installation looks a bit different depending on where your {pulsar-short} cluster is running.
Choose the option that best fits your needs.

[tabs]
====
{product}::
+
--
If you want a working RabbitMQ extension as quickly as possible, this is your best bet. This is also a good option for those that already have a streaming tenant and are looking to extend it.

. Sign in to your {product-short} account and navigate to your streaming tenant.
+
TIP: Don't have a streaming tenant? Follow our "xref:astra-streaming:getting-started:index.adoc[]" guide.

. Go to the "Connect" tab and choose the "RabbitMQ" option.

. Click "Enable RabbitMQ".

. A message will let you know of the additions (and restrictions) that come with using {starlight-rabbitmq}.

. Click the "Enable RabbitMQ" button to confirm your understanding.

Your {product} tenant is ready for prime time! Continue to the next section of the guide to see it in action.
--
Luna Streaming::
+
--
The {starlight-rabbitmq} extension is included in the `luna-streaming-all` image used to deploy a Luna cluster. The Luna helm chart makes deploying the Kafka extension quite easy. Follow the "xref:luna-streaming:components:starlight-for-rabbitmq.adoc[]" guide to create a simple {pulsar-short} cluster with the {starlight-rabbitmq} extension ready for use.
--
Self Managed::
+
--
Already have your own {pulsar-short} Cluster? Or maybe you're using a standalone cluster? {starlight-rabbitmq} can easily be a part of that cluster! Follow the "xref:starlight-for-rabbitmq:installation:getting-started.adoc[]" guide.
--
====

== Messaging with {starlight-rabbitmq}

{starlight-rabbitmq} supports quite a few different use cases.
With a {pulsar-short} cluster between publishers and consumers you can interchange the type of publisher and consumer to fit your needs.

*The below examples are using an {product} tenant as the AMQP listener.* If you are using Luna Streaming or a self-managed tenant, switch the listener URL for your own.

=== Retrieve RabbitMQ connection properties in {product}

In the {product} portal "Connect" tab, the "RabbitMQ" area provides important connection information.
You will need this connection information to create a working RabbitMQ client or use the CLI.

image:rabbitmq-client-settings.png[{product} RabbitMQ settings]

TIP: Click the clipboard icon to copy the RabbitMQ connection values, as well as a working token to paste in code.

=== Produce and consume a message

This example uses Maven for the project structure for a Rabbit MQ Java client.
If you prefer Gradle or another tool, this code should still be a good fit.

For complete source code examples, see the https://github.com/datastax/astra-streaming-examples[{product} examples repository].

. Create a new Maven project.
+
[source,shell]
----
mvn archetype:generate \
    -DgroupId=org.example \
    -DartifactId=StarlightForRabbitMqClient \
    -DarchetypeArtifactId=maven-archetype-quickstart \
    -DinteractiveMode=false

cd StarlightForRabbitMqClient
----

. Open the new project in your IDE or text editor, and then add the RabbitMQ client dependency to `pom.xml`:
+
[source,xml]
----
<dependency>
  <groupId>com.rabbitmq</groupId>
  <artifactId>amqp-client</artifactId>
  <version>5.16.0</version>
</dependency>
----

. Open the file `src/main/java/org/example/App.java`, and then enter the following code.
If you cloned the example repo, replace the entire contents with the following code.
Your editor will report errors because this isn't a complete program yet.
+
Replace placeholders with the values you previously retrieved from {product}.
+
[source,java]
----
package org.example;

import com.rabbitmq.client.*;

import java.io.IOException;
import java.net.URISyntaxException;
import java.nio.charset.StandardCharsets;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.util.concurrent.TimeoutException;

public class App {
  private static final String username = "";
  private static final String password = "<REPLACE_WITH_PULSAR_TOKEN>";
  private static final String host = "<REPLACE_WITH_SERVICE_URL>";
  private static final int port = 5671;
  private static final String virtual_host = "<REPLACE_WITH_TENANT_NAME>/<REPLACE_WITH_NAMESPACE>"; //The "rabbitmq" namespace should have been created when you enabled S4R
  private static final String queueName = "<REPLACE_WITH_TOPIC_NAME>"; //This will get created automatically
  private static final String amqp_URI = String.format("amqps://%s:%s@%s:%d/%s", username, password, host, port, virtual_host.replace("/","%2f"));

  public static void main(String[] args) throws IOException, TimeoutException, URISyntaxException, NoSuchAlgorithmException, KeyManagementException, InterruptedException {
----

. Add the code to create a connection, channel, and queue that will be used by both the producer and consumer:
+
[source,java]
----
    ConnectionFactory factory = new ConnectionFactory();
    factory.setUri(amqp_URI);

    /*
    You could also set each value individually
      factory.setHost(host);
      factory.setPort(port);
      factory.setUsername(username);
      factory.setPassword(password);
      factory.setVirtualHost(virtual_host);
      factory.useSslProtocol();
     */

    Connection connection = factory.newConnection();
    Channel channel = connection.createChannel();

    channel.queueDeclare(queueName, false, false, false, null);
----

. Add the producer code, which is a simple flow that sends a single message and awaits acknowledgment:
+
[source,java]
----
    String publishMessage = "Hello World!";
    channel.basicPublish("", queueName, null, publishMessage.getBytes());
    System.out.println(" Sent '" + publishMessage + "'");
----

. Add the consumer code, which creates a basic consumer with callback on message receipt.
Because the consumer isn't a blocking thread, the `sleep` allows time for messages to be received and processed.
+
[source,java]
----
    DeliverCallback deliverCallback = (consumerTag, delivery) -> {
      String consumeMessage = new String(delivery.getBody(), StandardCharsets.UTF_8);
      System.out.println(" Received '" + consumeMessage + "'");
    };

    channel.basicConsume(queueName, true, deliverCallback, consumerTag -> { });

    Thread.sleep(4000); // wait a bit for messages to be received

    channel.close();
    connection.close();
  }
}
----

. Build and run the JAR file for the complete program:
+
[source,shell]
----
mvn clean package assembly:single
java -jar target/StarlightForRabbitMqClient-1.0-SNAPSHOT-jar-with-dependencies.jar
----
+
.Result
[%collapsible]
====
[source,shell]
----
Sent 'Hello World!'
Received 'Hello World!'
----
====

== Next steps

* xref:starlight-for-rabbitmq:ROOT:index.adoc[{starlight-rabbitmq} documentation]
* xref:luna-streaming:components:starlight-for-rabbitmq.adoc[]