= {pulsar-reg} functions
:navtitle: {pulsar-short} functions

Functions are lightweight compute processes that enable you to process each message received on a topic.
You can apply custom logic to that message, transforming or enriching it, and then output it to a different topic.

Functions run inside {product} and are therefore serverless.
You write the code for your function in Java, Python, or Go, then upload the code.
It is automatically run for each message published to the specified input topic.

Functions are implemented using https://pulsar.apache.org/docs/en/functions-overview/[{pulsar-reg} functions].

[IMPORTANT]
====
Custom functions require a xref:astra-streaming:operations:astream-pricing.adoc[paid {product} plan].

Organizations on the *Free* plan can use xref:functions:index.adoc[transform functions] only.
====

== Deploy Python functions in a zip file

{product} supports Python-based {pulsar-short} functions.
These functions can be packaged in a zip file and deployed to {product} or {pulsar-short}.
The same zip file can be deployed to either environment.

To demonstrate this, the following steps create function configuration YAML file, package all necessary function files as a zip archive, and then use the `pulsar-admin` CLI to deploy the zip.
The configuration file defines the {pulsar-short} function options and parameters.

[TIP]
====
For video demos of a {pulsar-short} Python function, see the *Five Minutes About {pulsar-short}* series provides:

video::OCqxcNK0HEo[youtube, list=PL2g2h-wyI4SqeKH16czlcQ5x4Q_z-X7_m, height=445px,width=100%]
====

. Create a directory and subdirectories for your function zip archive with the following structure:
+
[source,plain]
----
/parent-directory
   /python-code
      /deps
      /src
----
+
For example, a function called `my-python-function` could have the following structure:
+
[source,plain]
----
/my-python-function
   python-code/my-python-function.zip
   python-code/deps/sh-1.12.14-py2.py3-none-any.whl
   python-code/src/my-python-function.py
----
+
The following commands create the necessary directories for a function called `demo-function`:
+
[source,bash]
----
mkdir demo-function
mkdir demo-function/python-code
mkdir demo-function/python-code/deps/
mkdir demo-function/python-code/src/
----

. Create a Python file in the `/src` directory.
For example:
+
[source,bash]
----
touch demo-function/python-code/src/demo-function.py
----

. Add your function code to your Python file.
This example function adds an exclamation point to the end of each message:
+
[source,python]
----
from pulsar import Function

class ExclamationFunction(Function):
  def __init__(self):
    pass

  def process(self, input, context):
    return input + '!'
----

. Add your function's dependencies to the `demo-function/python-code/deps` directory.
This example uses the `pulsar-client` library:
+
[source,bash]
----
cd deps
pip install pulsar-client==2.10.0
----

. Create the zip archive for your function in the `python-code` directory.
+
For example, the following command is run from within the `/deps` directory and creates the `demo-function.zip` file in the parent `python-code` directory.
+
[source,bash]
----
cd deps
zip -r ../demo-function.zip .
----
+
Wait while the archive is packaged.

. Verify that the zip file is in the `python-code` directory:
+
[source,bash]
----
python-code ls -al
----
+
.Result
[%collapsible]
====
[source,console]
----
deps
demo-function.zip
src
----
====

=== Deploy a Python function with configuration file

. Create a deployment configuration file named `func-create-config.yaml` with the following contents.
This file is passed to the `pulsar-admin` create function command.
+
[source,yaml,subs="+quotes"]
----
py: /absolute/path/to/demo-function.zip
className: pythonfunc.ExclamationFunction
parallelism: 1
inputs:
 - persistent://**TENANT_NAME**/**NAMESPACE_NAME**/**INPUT_TOPIC_NAME**
output: persistent://**TENANT_NAME**/**NAMESPACE_NAME**/**OUTPUT_TOPIC_NAME**
autoAck: true
tenant: **TENANT_NAME**
namespace: **NAMESPACE_NAME**
name: demofunction
logTopic:
userConfig:
 logging_level: ERROR
----
+
Replace the following:
+
* `**TENANT_NAME**`: The tenant where you want to deploy the function
* `**NAMESPACE_NAME**`: The namespace where you want to deploy the function
* `**INPUT_TOPIC_NAME**`: The input topic for the function
* `**OUTPUT_TOPIC_NAME**`: The output topic for the function

. Use `pulsar-admin` to deploy the Python zip to {product} or {pulsar-short}.
The command below assumes you've properly configured the `client.conf` file for `pulsar-admin` commands against your {pulsar-short} cluster. If you are using {product}, see xref:astra-streaming:developing:configure-pulsar-env.adoc[] for more information.
+
[source,console]
----
bin/pulsar-admin functions create --function-config-file /absolute/path/to/func-create-config.yml
----

. Verify that the function was deployed:
+
* Go to the {astra-ui} to see your newly deployed function listed under the **Functions** tab for your tenant.
See <<controlling-your-function,Controlling your function>> for more information on testing and monitoring your function in {product}.
* Use the `pulsar-admin` CLI to list functions for a specific tenant and namespace:
+
[source,bash,subs="+quotes"]
----
bin/pulsar-admin functions list --tenant **TENANT_NAME** --namespace **NAMESPACE_NAME**
----

== Deploy Java functions in a JAR file

{product} supports Java-based {pulsar-short} functions which are packaged in a JAR file.
The JAR can be deployed to {product} or {pulsar-short}.
The same JAR file can be deployed to either environment.

In this example, you'll create a function JAR file using Maven, then use the `pulsar-admin` CLI to deploy the JAR.
You'll also create a function configuration YAML file that defines the {pulsar-short} function options and parameters.

. Create a properly-structured JAR with your function's Java code.
For example:
+
.Example: Function pom.xml
[%collapsible]
====
[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>java-function</groupId>
    <artifactId>java-function</artifactId>
    <version>1.0-SNAPSHOT</version>

    <dependencies>
        <dependency>
            <groupId>org.apache.pulsar</groupId>
            <artifactId>pulsar-functions-api</artifactId>
            <version>3.0.0</version>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <configuration>
                    <appendAssemblyId>false</appendAssemblyId>
                    <descriptorRefs>
                        <descriptorRef>jar-with-dependencies</descriptorRef>
                    </descriptorRefs>
                    <archive>
                    <manifest>
                        <mainClass>org.example.test.ExclamationFunction</mainClass>
                    </manifest>
                </archive>
                </configuration>
                <executions>
                    <execution>
                        <id>make-assembly</id>
                        <phase>package</phase>
                        <goals>
                            <goal>assembly</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <release>17</release>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
----
====

. Package the JAR file with Maven:
+
[source,bash]
----
mvn package
----
+
.Result
[%collapsible]
====
[source,console]
----
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  10.989 s
[INFO] Finished at: 2023-05-16T16:19:05-04:00
[INFO] ------------------------------------------------------------------------
----
====

. Create a deployment configuration file named `func-create-config.yaml` with the following contents.
This file is passed to the `pulsar-admin` create function command.
+
[source,yaml]
----
jar: /absolute/path/to/java-function.jar
className: com.example.pulsar.ExclamationFunction
parallelism: 1
inputs:
  - persistent://mytenant/n0/t1
output: persistent://mytenant/ns/t2
autoAck: true
tenant: mytenant
namespace: ns0
name: testjarfunction
logTopic:
userConfig:
  logging_level: ERROR
----
+
[IMPORTANT]
====
{product} requires the `inputs` topic to have a message schema defined before deploying the function.
Otherwise, deployment errors may occur.
Use the {astra-ui} to define the message schema for a topic.
====

. Use the `pulsar-admin` CLI to deploy your function JAR to {product} or {pulsar-short}.
+
The following command assumes you've properly configured the `client.conf` file for `pulsar-admin` commands against your {pulsar-short} cluster.
If you are using {product}, see xref:astra-streaming:developing:configure-pulsar-env.adoc[] for more information.
+
[source,bash]
----
bin/pulsar-admin functions create --function-config-file  /absolute/path/to/func-create-config.yml
----

. Verify that the function was deployed:
+
* Go to the {astra-ui} to see your newly deployed function listed under the **Functions** tab for your tenant.
See <<controlling-your-function,Controlling your function>> for more information on testing and monitoring your function in {product}.
* Use the `pulsar-admin` CLI to list functions for a specific tenant and namespace:
+
[source,bash,subs="+quotes"]
----
bin/pulsar-admin functions list --tenant **TENANT_NAME** --namespace **NAMESPACE_NAME**
----

== Add functions in {product} dashboard

Add functions in the **Functions** tab of the {product} dashboard.

. Select *Create Function* to get started.

. Choose your function name and namespace.
+
image::astream-name-function.png[Function and Namespace]

. Select the file you want to pull the function from and which function you want to use within that file.
{product} generates a list of acceptable classes.
+
image::astream-exclamation-function.png[Exclamation Function]
+
There are differences depending on the function language:
+
* Python functions are added by loading a Python file (`.py`) or a zipped Python file (`.zip`).
+
When adding Python files, the Class Name is specified as the name of the Python file without the extension plus the class you want to execute.
For example, if the Python file is called `testfunction.py` and the class is `ExclamationFunction`, then the class name is `testfunction.ExclamationFunction`.
+
The file can contain multiple classes, but only one is used.
If there is no class in the Python file (when using a basic function, for example), specify the filename without the extension, such as `testfunction`.
+
* Java functions are added by loading a Java jar file (`.jar`).
When adding Java files, you must specify the name of the class to execute as the function.

. Select your input topics.
+
image:streaming-learning:functions:astream-io-topics.png[IO Topics]

. Select **Optional Destination Topics** for output and logging.
+
image:streaming-learning:functions:astream-optional-destination-topics.png[Optional Topics]

. If applicable, configure the *Advanced Options*.
+
image:streaming-learning:functions:astream-advanced-config.png[Advanced Configuration]

. Run at least one sink instance.

. Select an option for *Processing Guarantee*:
+
* *ATLEAST_ONCE* (default): Each message sent to the function can be processed more than once.
* *ATMOST_ONCE*: The message sent to the function is processed at most once. Therefore, there is a chance that the message is not processed.
* *EFFECTIVELY_ONCE*: Each message sent to the function will have one output associated with it.

. Provide an *Option Configuration Key*.
See the https://pulsar.apache.org/functions-rest-api/#operation/registerFunction[{pulsar-short} documentation] for a list of configuration keys.
+
image:streaming-learning:functions:astream-provide-config-keys.png[Provide Config Key]

. Click *Create*.

. To verify that the function was created, review the list of functions on the *Functions* tab.

== Add function with {pulsar-short} CLI

You can add functions using the {pulsar-short} CLI.

The following example creates a Python function that consumes a message from one topic, adds an exclamation point, and then publishes the results to another topic.

. Add the following Python function code to a file named `testfunction.py`:
+
.testfunction.py
[source, python]
----
from pulsar import Function

class ExclamationFunction(Function):
  def __init__(self):
    pass

  def process(self, input, context):
    return input + '!'
----

. Deploy `testfunction.py` to your {pulsar-short} cluster using the {pulsar-short} CLI:
+
[source,bash,subs="+quotes"]
----
$ ./pulsar-admin functions create \
  --py /absolute/path/to/testfunction.py \
  --classname testfunction.ExclamationFunction \
  --tenant **TENANT_NAME** \
  --namespace default \
  --name exclamation \
  --auto-ack true \
  --inputs persistent://**TENANT_NAME**/default/in \
  --output persistent://**TENANT_NAME**/default/out \
  --log-topic persistent://**TENANT_NAME**/default/log
----
+
Replace **TENANT_NAME** with the name of the tenant where you want to deploy the function.
If you want to use a different namespace, replace `default` with another namespace name.
If you want to use different topics, change `in`, `out`, and `log` accordingly.

. Verify that the response is `Created Successfully!`.
This indicates that the function was deployed and ready to run when triggered by incoming messages.
+
If the response is `402 Payment Required` with `Reason: only qualified organizations can create functions`, then you must upgrade to a xref:astra-streaming:operations:astream-pricing.adoc[paid {product} plan].
Organizations on the *Free* plan can use xref:functions:index.adoc[transform functions] only.
+
You can also verify that a function was created by checking the **Functions** tab or by running `./pulsar-admin functions list --tenant **TENANT_NAME**`.

== Testing Your Function

Triggering a function is a convenient way to test that the function is working.
When you trigger a function, you publish a message on the function's input topic, which triggers the function.





. Listen for messages on the output topic:
+
[source,bash,subs="+quotes"]
----
$ ./pulsar-client consume persistent://**TENANT_NAME**/default/out \
  --subscription-name my-subscription \
  --num-messages 0 # Listen indefinitely
----
+
Replace **TENANT_NAME** with the name of the tenant where you deployed the function.
If your function uses a different namespace and output topic name, replace `default` and `out` accordingly.
+
If the function has an output topic, and the function returns data to the output topic, then that data is returned by the listener when you run the function.

. Send a test value with the {pulsar-short} CLI `trigger` command:
+
[source,bash,subs="+quotes"]
----
$ ./pulsar-admin functions trigger \
  --name exclamation \
  --tenant **TENANT_NAME** \
  --namespace default \
  --trigger-value "Hello world"
----
+
This command sends the string `Hello world` to the exclamation function.
If deployed and configured correctly, the function should output `Hello world!` to the `out` topic.

[#controlling-your-function]
== Controlling Your Function

You can start, stop, and restart your function by selecting it in the *Functions* dashboard.

image:streaming-learning:functions:astream-function-controls.png[Function Controls]

== Monitoring Your Function

Functions produce logs to help you in debugging.
To view your function's logs, open your function in the *Functions* dashboard.

image:streaming-learning:functions:astream-function-log.png[Function Log]

In the upper right corner of the function log are controls to *Refresh*, *Copy to Clipboard*, and *Save* your function log.

== Updating Your Function

A function that is already running can be updated with new configuration.
The following settings can be updated:

* Function code
* Output topic
* Log topic
* Number of instances
* Configuration keys

If you need to update any other setting of the function, delete and then re-add the function.

. To update your function, select the function in the *Functions* dashboard.

image::astream-function-update.png[Update Function]

. Click *Change File* to select a local function file, and then click *Open*.

. Update your function's *Instances* and *Timeout*.

. Click *Update*.
+
An *Updates Submitted Successfully* message confirms that the function was updated.

== Deleting Your Function

. Select the function to be deleted in the *Functions* dashboard.

image::astream-delete-function.png[Delete Function]

. Click *Delete*.

. To confirm the deletion, enter the function's name, and then click *Delete*.
+
A *Function-name Deleted Successfully!* message confirms the function was permanently deleted.

== Next steps

Learn more about developing functions for {product} and {pulsar-short} https://pulsar.apache.org/docs/en/functions-develop/[here].